# 동시성 제어(Concerrency Control)

동시성 제어란 DBMS가 다수의 사용자 사이에서 동시에 작용하는 다중 트랜잭션의 상호간섭 작용에서 Database를 보호하는 것을 의미한다. 일반적으로 동시성을 허용하면 일관성이 낮아지게 되며 이를 그래프로 나타내면 아래와 같다.

![동시성과 일관성은 반비례 관계](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FYYwAw%2FbtqAhqpozl2%2FIMdpfbgguBj897K4VkEwy1%2Fimg.png)

다수 사용자의 동시 접속을 위해 DBMS는 동시성 제어를 할 수 있도록 Lock 기능과 SET TRANSACTION 명령어를 이용해 트랜잭션의 격리성 수준을 조정할 수 있는 기능도 제공한다. 이렇게 동시성을 제어하는 방법에는 낙관적 동시성 제어와 비관적 동시성 제어가 있다.

## 낙관적 동시성 제어(Optimistic Concurrency Control)

^412d08

- 사용자들이 같은 데이터를 동시에 수정하지 않을 것이라고 가정
- 데이터를 읽는 시점에 Lock을 걸지 않는 대신 <u>수정 시점에 값이 변경됐는지를 반드시 검사</u>

## 비관적 동시성 제어(Pessimistic Concurrency Control)

- 사용자들이 같은 데이터를 동시에 수정할 것이라고 가정
- 데이터를 읽는 시점에 Lock을 걸고, 트랜잭션이 완료될 때까지 이를 유지
- SELECT 시점에 Lock을 거는 비관적 동시성 제어는 시스템의 동시성을 심각하게 떨어뜨릴 수 있어서 wait 또는 nowait 옵션과 함께 사용해야 함

동시성 제어의 목표는 <u>동시에 실행되는 트랜잭션 수를 최대화 하면서 입력, 수정, 삭제, 검색 시 데이터의 무결성을 유지</u>하는데 있다. 따라서 동시 업데이트가 거의 없는 경우라면 낙관적 잠금을 사용하면 되지만, 그렇지 않다면 비관적 제어를 사용해야 한다.

# 공유락(Shared Lock)과 배타락(Exclusive Lock)

<u>비관적 동시성 제어를 위한 대표적인 방법으로 Lock</u>이 있는데, 크게 공유락(Shared Lock)과 배타락(Exclusive Lock)이 있다.

- 공유락(Shared Lock): 읽기 잠금
- 배타락(Exclusive Lock): 쓰기 잠금

동일한 레코드에 대해 각각 공유락과 배타락을 가져간 경우의 동작은 다음과 같다.

## 1번 트랜잭션이 공유락을 가져간 경우

- 2번 트랜잭션이 데이터를 읽는 경우
  데이터가 일관되므로, 2번 트랜잭션이 또 다른 공유락을 가져가면서 동시에 처리함
- 2번 트랜잭션이 데이터를 쓰는 경우
   <u>1번 트랜잭션과 데이터가 달라질 수 있므로 1번 트랜잭션 종료까지</u> 기다려야 함

## 1번 트랜잭션이 배타락을 가져간 경우  

- 2번 트랜잭션이 데이터를 읽는 경우, 1번 트랜잭션이 데이터를 변경할 수 있으므로 기다림
- 2번 트랜잭션이 데이터를 쓰는 경우에도, 1번 트랜잭션이 데이터를 변경할 수 있으므로 기다림


>[!warning] 참고로 획득한 락을 해제하는 방법은 결국 커밋과 롤백 밖에 없다.

이러한 문제점들을 해결하기 위해 [[MVCC(다중 버전 동시성 제어)]](Multi-Version Concurrency Control, 다중 버전 동시성 제어)이 탄생하게 되었다.

---
[\[Database\] MVCC(다중 버전 동시성 제어)란?](https://mangkyu.tistory.com/53)

