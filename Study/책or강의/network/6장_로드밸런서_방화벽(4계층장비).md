# 6장: 로드밸런서/ 방화벽: 4계층 장비(세션장비)
>**intro**
기존 네트워크 장비 -> 2,3계층
> => IP부족으로 NAT기술 등장, 보안용 방화벽, 프록시와 같은 장비들이 등장하면서 4계층 장비도 네트워크 장비로 포함
> => 포트번호, 시퀀스 번호, ACK번호에 대해 이해해야 하며, 이 정보들은 ==세션테이블==에 담아 관리

## 6.1: 4계층 장비의 특징
==TCP==와 같은 4계층 헤더에 있는 정보를 이해하고, 이 정보를 기반으로 동작한다.
기존 네트워크 장비와 다른점을 이해해야 하는데, 세션 테이블과 그 안에서 관리하는 세션 정보가 가장 중요하다.

- 세션테이블
	- 세션 장비는 세션 테이블을 기반으로 운영
	- 세션 정보는 테이블에 남아있는 *라이프타임*이 존재
	- Symmetric(대칭)요구; Inbound와 Outbound 경로가 일치해야 한다.
	- 정보 변경(로드 밸런서의 경우)
		- IP주소가 변경되며 확장된 L7로드 밸런서는 애플리케이션 프로토콜 정보도 변경

방화벽, NAT, 로드 밸런서와 같은 장비가 있을 경우, 네트워크 인프라뿐만 아니라 시스템 설계와 애플리케이션 개발에도 세션 장비에 대한 고려가 필요하다.

## 6.2: 로드밸런서
서버나 장비의 부하를 분산하기 위해 사용하는 장비.
*4계층 이상*에서 동작하면서 IP주소나 4계층 정보, 애플리케이션 정보를 확인, 수정하는 기능이 있다.
- 웹 애플리케이션
- FWLB(FireWall Load Balancing: 방화벽 로드 밸런싱)
- VPNLB(VPN Load Balancing)
등에서 사용

> **L4로드 밸런싱**
> 일반적인 로드 밸런서가 동작하는 방식. TCP, UDP정보를 기반으로 로드밸런싱 수행
> L7지원 여부와 상관없이 4계층에 대한 정보로만 분산처리를 하는 경우 L4로드밸런싱

> **L7로드 밸런싱** => ADC(Application Delivery Control; proxy역할을 수행)
> HTTP, FTP, SMTP 와 같은 애플리케이션 프로토콜 정보를 기반으로 로드밸런싱을 수행
> HTTP헤더정보와 URI와 같은 정보를 기반으로 프로토콜을 이해한 후 부하를 분산

**AWS => NLB(Network Load Balacer; L4), ALB(Application Load Balancer; L7)**

### 6.2.1 L4 스위치 (4계층 로드 밸런서 기능의 스위치)
내부 동작방식은 4계층 로드밸런서/ 외형은 스위치처럼 여러 개의 포트가 있다.
서버형 로드밸런서나 소프트웨어 형태의 로드밸런서도 있지만, 다양한 네트워크 구성이 가능한 스위치형 로드 밸런서가 가장 대중화 되어있다.
- 부하분산
- 성능 최적화
- 리다이렉션

L4 스위치가 동작하려면 아래를 설정해야함
```plain text
- 가상 서버(Virtual Server)
- 가상 IP(Virtual IP)
- 리얼 서버(Real Server)
- 리얼 IP(Real IP)
```
1. 가상IP를 목적지로 서비스 요청
2. L4스위치가 목적지로 설정된 가상 IP를 리얼 IP로 다시 변경해 보내줌

### 6.2.2 ADC(Application Delivery Controller)
애플리케이션 계층(7계층)에서 동작하는 **로드밸런서**
애플리케이션 프로토콜의 헤더와 내용을 이해하고 동작. 부하분산, 정보 수정, 정보 필터링이 가능하다.
- 대부분 ADC의 기능
	- 4계층 ~ 7계층 로드밸런싱
	- 페일오버(Failover, 장애극복 기능)
	- 리디렉션(Redirection)기능 함께 제공
	- 애플리케이션 프로토콜 이해, 최적화하는 기능
		- 캐싱(Caching)
		- 압축(Compression)
		- 콘텐츠 변환 및 재작성
		- 인코딩 변환
		- 애플리케이션 프로토콜 최적화
		- 플러그인 형태로
			- WAF(Web Application Firewall)
			- HTML, XML검증과 변환

### 6.2.3 L4스위치 vs ADC
- L4
	- 4계층에서 동작, TCP/ UDP 정보를 기반으로 부하를 분산
	- TCP계층에서 최적화/ 보안 기능 함께 제공(Dos 공격 방어, TCP세션 재사용)
- ADC
	- 애플리케이션 프로토콜 이해, 내용에 대한 분산, 리디렉션, 최적화
	- 서버에서 수행하는 작업 중 부하가 많이 걸리는 작업 별도로 수행
		-> ex)이미지, 정적 콘탠츠 캐싱(Caching)
		-> 하드웨어 가속, 소프트웨어 최적화를 통해 이러한 부하가 걸리는 작업 최적화
		- 클라이언트 -> ADC까지 SSL로 처리, ADC -> 서버 HTTP로 통신
			웹서버 여러대의 SSL통신을 하나의 ADC에서 수용하기 위해 ADC에 전용 ssl 가속 카드 내장

>**시스템 확장 방법: 스케일 업, 스케일 아웃 <-> 스케일 다운, 스케일 인**
>![[scale-up_scale-out.jpg]]


## 6.3 방화벽
네트워크 중간에 위치해 해당 장비를 통과하는 트래픽을 사전에 주어진 정책에 맞추어 허용하거나 차단하는 장비.
네트워크에서 보안을 제공하는 장비를 넓은 의미에서는 모두 방화벽으로 불러왔지만, **<u>네트워크 3,4 계층에서 동작</u>하고 세션을 인지, 관리하는 *SPI(Stateful Packet Inspection)엔진을 기반*으로 동작하는 장비를 방화벽** 이라고 한다.

방화벽은 NAT(Network Address Translation)동작 방식과 유사하게 세션 정보를 장비 내부에 저장. 방화벽은 세션 테이블을 이용해 패킷의 인과관계를 파악한다. 이로 인해 정책을 간단히 유지 할 수 있다. (기본 정책: 나가는 모든 패킷 허용, 들어오는 모든 패킷 차단)

## 6.4 4계층 장비를 통과할 때의 유의점 (세션 관리)
(201p) 세션 테이블 정보를 이용해 패킷을 변경하거나, 애플리케이션 성능을 최적화하고 보안을 강화하기 위해 패킷을 포워드 하거나 드롭 할 수 있다.
-> 애플리케이션의 세션시간과 서비스 방향성을 고려, 비대치 경로를 피하는 것이 매우 중요하다.

### 6.4.1 세션 테이블 유지, 세션 정보 동기화
![[fire-ware_session-table.jpg]]
1. 세션 장비 운영자 입장
	1. 세션 만료 기간 증가
	2. 세션 시간을 둔 채로 중간 패킷을 수용할 수 있도록 방화벽 설정(세션 장비 중 방화벽에 해당)
	3. 세션 장비에서 세션 타임아웃 시 양 단말에 세션 종료 통보
2. 개발자 입장
	- 애플리케이션에서 주기적인 패킷 발생 기능 추가

### 6.4.2 비대칭 경로 문제
네트워크의 안정성을 높이기 위해 네트워크 회선과 장비를 이중화 하는데, 이 때 패킷이 지나가는 경로가 2개 이상이므로 인바운드 패킷과 아웃바운드 패킷의 경로가 같거나 다를 수 있다.
- 인바운드 패킷, 아웃바운드 패킷
	- 같은 장비를 통과 -> 대칭 경로(Symmentric Path)
	- 다른 장비를 통과 -> 비대칭 경로(Asymmetric Path)
		- 세션 장비에 비대치 경로를 처리하는 기능을 이용할수 있지만, 비대칭 패킷을 처리하기 위하여 세션 장비의 성능이 저하되거나, 보안이 약화 될 수있다.

세션 장비는 세션 테이블을 만들어야 하므로 패킷이 들어오고 나갈때 동일한 장비를 통과해야함. 그러나 2,3 계층 네트워크 장비는 세션 고려가 필요 없어 네트워크 엔지니어 대다수가 세션 장비의 이런 특징을 파악하지 못하고 네트워크를 디자인 하는 경우가 있음
비대칭 경로 방화벽에서 처리하는 방법
1. 세션 테이블 동기화
	- 두개 경로 상의 두 장비가 하나의 장비처럼 동작.
	- 패킷 경로를 변경하지 않고 동작한다는 장점이 있지만, 동기화 시점에 따라 정상 동작하지 않을 수 있기 때문에 추천하지 않음
	- 응답시간이 비교적 긴 인터넷 게이트웨이로 방화벽이 사용될 때 유용하게 사용
2. 세션장비에서 보정
	- 인바운드 패킷이 통과하지 않았는데 아웃바운드 패킷이 장비로 들어온 경우, 인바운드 패킷이 통과한 다른 세션 장비 쪽으로 패킷을 보내 경로를 보정
	- MAC주소를 변경하는 MAC리라이팅이나 기존 패킷에 MAC주소를 한번 더 인캡슐레이션 하는 터널링 기법으로 경로를 보정

### 6.4.3 하나의 통신에 두 개 이상의 세션이 사용될 때의 고려사항
(208p) 서로 다른 두 세션이 하나의 통신을 위해 사용하고 있다는 것을 네트워크 통신 중간에 놓인 세션 장비도 파악해야 한다.