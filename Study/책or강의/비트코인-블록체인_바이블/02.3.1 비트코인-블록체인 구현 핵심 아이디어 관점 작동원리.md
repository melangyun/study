
# 1) 비트코인 - 블록체인 작동 원리 핵심 아이디어

탈중앙화, 분산 장부, 화폐 발행, 유통 메커니즘을 구현하기 위해 다음과 같은 고민이 생겼다.

- 분산된 장부가 어떻게 합의에 도달할 것인가?
- 탈중앙화된 환경에서 합의 후 어떻게 위변조를 차단할 것인가?
- 어떤 방식으로 화폐를 발행할 것인가?
- 탈중앙화된 환경에서 어떻게 시스템을 작동시킬 것인가?

## POW(작업증명)

"단순하지만 일정한 시간이 요구되는 어려운 작업을 수행하게 함으로써 악의적인 행동을 차던-저지-지연-검증하기 위한 방안"
> 중앙 시스템이 존재하지 않기 때문에, 직접적 통제 - 제어가 불가능하기 때문

- 어려운 작업을 통해 통제되고 예측 가능한 화폐 발행
- 어려운 작업 수행에 대한 보상을 통해 자발적 참여 유인
- 어려운 작업을 수행한 노드가 대표블록 생성-합의 도달
- 어려운 작업을 요구하여 수정-삭제가 불가능하게 함

# 2) 작동 원리 이해를 위한 기본 개념 이해

![[블록생성과정(2-42).png]]
블록이 형태적으로 완성되기 위해 총 7개의 값이 결정되어야 한다.
- 블록 생성 또는 대표블록을 선정한다는 말은 이 7개 값을 결정해 가는 과정이라고 할 수 있다.

2(버전), 3(난이도), 5(Time)은 시스템적으로 값이 주어진다.
1(이전 블록 Hash), 4(머클루트)는 Body정보와 이전 블록의 해시정보로 결정된다.

`6(Nonce), 7(Hash of Block)` 값이 결정되면 정식 블록이 생성된다.
따라서 6,7을 결정하는 과정이 대표블록 선정 과정이자 Nouce 값을 찾는 POW이다.


## 후보블록 생성과정

1. 생성된 트랜잭션은 전파와 검증을 거쳐 각 노드의 MemPool에 저장된다.
2. MemPool에 저장된 트랜잭션을 선별하여 후보블록을 Body에 포함시킨다.
3. 각 트랜잭션의 해시값들을 하나의 해시값으로 Header의 '머클루트'에 포함시킨다.
4. 이전 블록의 해시값이 `후보블록 Header`의 '이전 블록 Hash'에 포함된다.

## 대표블록 생성 과정

1. Nonce 값 찾기(채굴)
	가장 먼저 Nonce 값을 찾으면 대표 블록으로 생성된다.
2. 대표블럭 생성

각 노드는 경쟁을 통해 가장 먼저 `Nonce`값과 `Block Hash`값을 찾으면 정식 블록을 생성하고 동시에 대표블록으로 선정된다.
> Block Hash는 해당 블록을 하나의 값으로 표현한 것이다. 결국 Nonce값만 결정되면 Block Hash값도 동시에 결정된다.

> [!warning] 대표블록이 동시에 2개 이상 생성되는 경우 (분기)
> 대표 블록으로 선정되었다고 해도 <u>분기 상황에서는 최종 승인된 블록이라고 할 수 없다.</u>
> 분기 상태가 해소되면 그때 승인 블록이 된다.
> - 후보블록: Nonce를 아직 찾지 못한 상태의 블록(모든 노드가 후보 블록을 가지고 있음)
> - 대표 블록:Nonce 값을 찾은 상태의 블록(하나의 노드만 대표 블록 생성)
> - 미승인블록: 분기가 발생한 상태에서 대표 블록
> - 승인블록: 분기 상태가 끝나고 블록체인에 최종적으로 선택되는 대표블록

## Nonce 개념 이해
![[Nonce값 찾기(2-46).png]]
- Header의 6개 정보 전체의 해시값을 구했을 때, 목푯값보다 작은 해시값을 충족하는 Nonce값을 찾는다.
다른 데이터들은 값이 이미 정해져 있기 때문에 현재 정해지지 않는 임의의 값이 필요하다. 그 값이 Nonce.

이 값을 찾는것을 채굴작업이라고 한다.

- Nonce값이 결정되면?
	- 블록이 생성된다.
	- 대표블록이 선정되어 네트워크에 산재한 장부가 합의된다.
	- 화폐가 발행된다. (블록 생성에 대한 대가로 화폐 지급)
	- Nonce 값이 결정되면 임의로 수정-삭제가 불가능해진다.

>[!info] 목표값보다 작은 해시값을 찾도록 설계한 이유
>Nonce 값을 찾는 과정에 `SHA-256` Hash함수를 사용한다.
>- SHA-256은 256bit 64자리 문자열을 반환한다. 
>
>이 경우의 수에서 하나의 특정 값을 찾는 것은 슈퍼컴퓨터로도 불가능하다. 따라서 그 값보다 작은 값의 아무 숫자나 나오면 조건을 충족한 것으로 간주한다.

## 분산 구조에서 합의 과정이란

합의에 도달하는 방식은 크게 2가지로 볼 수 있다.

- `PBFT`: 만장일치 또는 다수결이나 투표 등을 통해 '다수의 의견을 채택'
- `POW/POS`: 대표자나 리더를 선출하여 '대표자의 의견'을 따름

>[!info] POW / POS / PBFT
>- POW(Proof of Work): 작업증명 -> 작업에 의해 결정
>- POS(Proof of Stake): 지분증명  -> 지분에 의해 결정
>- PBFT(Practical Byzantine Fault Tolerance)
>	: 분산 컴퓨팅 시스템이나 네트워크에서 비잔틴 장애를 허용하면서도 시스템 정상 작동을 보장하는 합의 매커니즘 중 하나.
>	- 공개 블록체인이 아닌 허가형(Private)또는 컨소시엄 블록체인 네트워크에 사용되는 경우가 많다.
>	- 노드 간 상호 검증과 합의 과정을 통해 높은 처리량과 낮은 지연시간을 달성할 수 있다.


블록체인은 POW방식을 채택하고 있다.
![[합의과정이해(2-56).png]]
1. 각 노드는 기본적으로 동일한 장부를 가지고 있다. 전 세계에 퍼진 완전한 분산구조에서 전파 과정의 손실 및 지연 때문에 불일치가 발생할 수 있다.
2. 공유-전파 과정을 거쳐도 장부 불일치 상태가 발생할 수 있기 때문에, 대표자를 하나 선정하여 대표 장부를 다시 전파하는 방식으로 합의에 도달한다. 각 노드에 전파되어 저장된 트랜잭션들은 서로 불일치될 수 있지만,모두 검증을 거쳤기 때문에 누가 대표자가 되더라도 그 장부는 대표장부로서 신뢰할 수 있다.
3. 대표자가 선정되면 대표 장부를 다른 노드에 전파하여 받아들이게 함으로써 전체 네트워크상의 노드가 모두 동일한 장부로 동기화된다.
# 3) 비트코인 블록체인 작동 원리

- (가장 많은 작업을 했다는 것을 증명하면) `Nonce` 값을 가장 빨리 찾으면 대표 블록으로 선정되고, 네트워크 전체에 전파되어 합의에 도달한다.
- 수정하기 위해서는 Nonce값을 다시 찾아야만 하기 때문에 수정 자체가 어렵다.
- Nonce값을 찾으면 금을 채굴하듯이 화폐를 발행할 수 있다.
- Nonce값을 (자발적으로) 찾으면 인센티브로 새로운 화폐를 보상한다.

탈중앙시스템은 악의적 행동을 차단할 중앙관리자가 없기때문에 전혀 다른 접근법이 필요하다.
비트코인 POW에서는 탈중앙화 기반에서 필요한 기능과 역할을 POW 기반으로 조합해 최적의 메커니즘을 설계했다는데 큰 의미가 있다.