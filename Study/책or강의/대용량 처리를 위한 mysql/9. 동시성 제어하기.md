# 1. 멀티스레드 환경에 대한 이해

대부분 하나의 웹 서버는 여러 개의 요청을 동시에 수행할 수 있다. 작성한 코드 한 줄은 동시에 수행 될 수 있다.

하나의 자원을 두고 여러 개의 연산들이 경합하고, 이는 데이터 정합성을 깨뜨릴 수 있다.

> [!question] 어떻게 해결 할 수 있을까?
> 공유 자원에 대하여 잠금을 획득하여 줄 세우기를 할 수 있다.

# 2. 쓰기락과 읽기락

락을 통하여 동시성을 제어시 ==락의 범위를 최소화 하는것이 중요하다==
MySQL에서는 트랜잭션의 커밋 혹은 롤백 시점에 락이 풀린다.

MySQL에서는 쓰기락, 읽기락 두가지 잠금을 제공한다. ([[동시성 제어]] 참조!)

|        | 읽기락(Shared Lock) | 쓰기락(Exclusive Lock |
| :------: | :------------------- :| :---------------------: |
| 읽기락 | O                   | 대기                  |
| 쓰기락 | 대기                | 대기                  |

```SQL
// 읽기락
SELECT ... FOR SHARE
// 쓰기락
SELECT ... FOR UPDATE 또는 DELETE
```

매번 잠금이 발생할 경우, 성능저하는 피할 수 없다.
따라서 MySQL의 일반 SELECT의 경우 [ nonblocking consistent read](https://dev.mysql.com/doc/refman/5.7/en/innodb-consistent-read.html)로 동작한다.
(대기 없는 Read로 동작함)

## MySQL 에서 잠금은 row 가 아니라 index를 잠근다

> [[스토리지 엔진 수준의 락의 종류#^cfb617]] : 레코드락 참조

따라서 인덱스가 없는 조건으로 Locking Read시 불필요한 데이터들이 잠길 수 있다.

> [!Tip] 핵심 키워드
> - Java에서의 동시성 이슈 제어방법
> - 분산환경에서의 동시성 이슈 제어방법 
> - MySQL의 넥스트 키락이 등장한 배경
> - MySQL 외래키로 인한 잠금
> - MySQL 데드락


# 4. 낙관적 락

> [[동시성 제어#^412d08]] 낙관적 동시성 제어

- [*] [[CAS (Compare-And-Swap)]]을 통해 제어한다.

실패에 대한 처리를 직접 해줘야 하는 단점이 있다.
- 재시도, 노티, 그냥 버림, 등등..


# 7. 읽기와 쓰기의 트레이드 오프

1. 게시물에 컬럼 추가를 통한 구현 - 비관적 락    
2. 게시물에 컬럼 추가를 통한 구현 - 낙관적 락
3. 좋아요 테이블 추가를 통한 구현

## 컬럼을 통한 구현

1. 조회시 컬럼만 읽어오면 됨
2. 쓰기시 게시물 레코드에 대한 경합이 발생
-> 하나의 자원(게시물)을 두고 락 대기
3. 같은 회원이 하나에 게시물에 대해 여러 번 좋아요를 누를 수 있음

##  좋아요 테이블을 통한 구현

1. 조회시 매번 count 쿼리 연산
2. 쓰기시 경합없이 인서트만 발생
3. 회원정보등 다양한 정보 저장 가능

> 쓰기 지점은 병목은 하나의 레코드를 점유
> 조회 지점의 병목은 카운트 쿼리
> > 좋아요 수는 높은 정합성을 요구하는 데이터인가?

병목 해소하는 방법 
![[좋아요병목해소하기.png]]

이 버전을 채택할 경우 스케쥴러를 별도로 구성해야하고 관리해주어야함
만일 스케쥴러에 오류가 생길경우 고객은 계속해서 올바르지 않은 정보를 받고있는것이다.
또 이러한 유즈케이스의 경우 redis 를 사용하기 좋음
레디스를 통한 카운트 관리를 하기 좋음

내가 누른 좋아요가 곧 바로 반영이 될까?
> 클라이언트 캐시를 통해 해소가 가능하다.


데이터의 성질, 병목지점등을 파악하고, 적당한 기술들을 도입해 해소

+ 부하테스트를 자동화할수 있는 툴들이 있음. .엥글라이더?

> [!tip] 추가로 하면 좋을것들
> - Repository Layer를 JPA로 리팩토링
> - 팔로워가 100만명인 유저의 게시물 작성 성능 테스트
> - 비동기 큐를 통해 개선
> - Mixed Push / Pull Model
> - 로그인 / 팔로우 승인, 취소 / 댓글 구현
> - MySQL Master / Slave
> - 파티셔닝
